- content_for :title, I18n.t('occurrence.occurrence_title')
- content_for :scripts do
  %script{src: "//www.gstatic.com/charts/loader.js"}
  %script{src: "/js/jquery.throttledresize.js"}
  :javascript
    $(function() {
      var recorders_ids = $("p.orcid[data-recorders]").map(function() { return $(this).data('recorders'); }).get(),
          determiners_ids = $("p.orcid[data-determiners]").map(function() { return $(this).data('determiners'); }).get(),
          network = #{@network},
          selector_template = Handlebars.compile($('#selector-template').html());

      $.ajaxSetup({
        headers: { 'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content') }
      });

      function findOne (haystack, arr) {
        return arr.some(function (v) {
          return haystack.indexOf(v) >= 0;
        });
      }

      function activateRadios(ele) {
        $(ele).find("input.action-radio").on("change", function() {
          var row = $(this).parents("tr"),
              occurrence_id = $(this).attr("data-occurrence-id"),
              action = $(this).attr("data-action"),
              user_id = $(this).attr("data-user-id");

          //TODO: user might be determiner & so need to do a PUT to user_occurrence_id, not POST to occurrence_id
          $.ajax({
            method: "POST",
            url: "/help-others/user-occurrence/" + occurrence_id + ".json",
            dataType: "json",
            data: JSON.stringify({
              user_id: user_id,
              action: action,
              visible: true
            }),
            beforeSend: function(xhr) {
              $("label", row).addClass("disabled");
              $("button", row).addClass("disabled");
            }
          }).done(function(data) {
            location.reload();
          });

        });
      }

      function matchedPersonHTML(family) {
        var output = "", img = "";
        let found = network.find(x => x.familyName === family);
        if (found) {
          var url = (found.identifier[0] === "Q") ? "https://www.wikidata.org/wiki/" + found.identifier : "https://orcid.org/" + found.identifier;
          if (found.identifier[0] === "Q") {
            img = "<img src=\"/images/wikidata_24x24.png\" class=\"pr-1\" />";
          } else {
            img = "<i class=\"fab fa-orcid pr-1\"></i>";
          }
          output = "<table class=\"mb-2\">";
          output += "<tbody>";
          output += "<tr>";

          //TODO: if found.identifier exists in linked determinations, have to make microscope icon selected

          output += "<td class=\"selector\">" + selector_template({ user_id: found.user_id}) + "</td>";
          output += "<td><span class=\"d-block pl-2\">" + found.fullname_reverse + "<br>" + img + "<a href=\"" + url + "\" target=\"_blank\">" + url + "</a></span></td>";
          output += "</tr>";
          output += "</tbody>";
          output += "</table>";
        }
        return output;
      }

      $.each(['recorders', 'determiners'], function() {
        var type = this;

        $('.agent_' + type).each(function() {
          var self = this;
          $.ajax({
            method: "GET",
            url: "/user.json?q=" + $(self).text(),
            dataType: "json"
          }).done(function(data) {
            var searched_ids = $.map(data, function(i) { return i.wikidata || i.orcid }),
                icon = $(self).find("i").removeClass("fa-spinner").removeClass("fa-pulse");
            if (findOne(searched_ids, eval(type + "_ids"))) {
              icon.addClass("fa-check").addClass("text-success");
            } else {
              if ($.map(network, function(id) { return id.familyName; }).includes($(self).data("family"))) {
                icon.remove();
                $(self).find("span").addClass("font-weight-bold").after(matchedPersonHTML($(self).data("family")));
                activateRadios($(self));
              } else {
                icon.addClass("fa-question").addClass("text-warning");
              }
            }
          });
        });
      });

      if (!$('#map').length) { return; }

      var map;

      function drawVisualizations() {
        var options = {
          displayMode: 'markers',
          colorAxis: { colors: ['white'] },
          tooltip: { trigger: 'none'}
        };

        var data = google.visualization.arrayToDataTable([
          ['Lat', 'Long', 'Name'],
          [#{@occurrence.decimalLatitude}, #{@occurrence.decimalLongitude}, "#{@occurrence.scientificName}"]
        ]);

        map = new google.visualization.GeoChart($('#map')[0]);
        map.draw(data, options);
      }

      google.charts.load('current', {
        packages: ['corechart','geochart'],
        mapsApiKey: "#{Settings.google.api_key}"
      });
      google.charts.setOnLoadCallback(drawVisualizations);

      $(window).on("throttledresize", function(event) {
        map.clearChart();
        drawVisualizations();
        $("#map-wrapper").height(map.container.offsetHeight);
      });

    });

- content_for :jumbotron do
  .jumbotron.jumbotron-fluid.d-flex.flex-wrap
    .mr-auto.p-2
      %h1.h2= I18n.t('occurrence.occurrence_title')
      %p.lead.text-muted= I18n.t('occurrence.lede')

.card-deck.occurrence.mt-4
  .card.mb-4
    .card-header.border-bottom
      %h5= I18n.t('occurrence.record')
    .card-body.mt-2
      %dl.dl-horizontal
        %dt gbifID
        %dd.py-1
          %a{href: gbif_occurrence_url(@occurrence.id), target:"_blank"}
            #{@occurrence.id}
            %i.fas.fa-external-link-alt
        %dd.line-break

        %dt datasetKey
        %dd.py-1
          - if @occurrence.datasetKey
            %a{href: "https://gbif.org/dataset/#{@occurrence.datasetKey}", target:"_blank"}
              #{@occurrence.datasetKey}
              %i.fas.fa-external-link-alt
        %dd.line-break

        %dt occurrenceID
        %dd.py-1
          - if @occurrence.occurrenceID && @occurrence.occurrenceID[0..3] == "http"
            %a{href: "#{@occurrence.occurrenceID}", target:"_blank"} #{@occurrence.occurrenceID}
          - else
            #{h(@occurrence.occurrenceID)}
        %dd.line-break

        %dt institutionCode
        %dd.py-1 #{h(@occurrence.institutionCode)}
        %dd.line-break

        %dt collectionCode
        %dd.py-1 #{h(@occurrence.collectionCode)}
        %dd.line-break

        %dt catalogNumber
        %dd.py-1 #{h(@occurrence.catalogNumber)}
        %dd.line-break

        %dt basisOfRecord
        %dd.py-1 #{h(@occurrence.basisOfRecord)}
        %dd.line-break

        %dt #{I18n.t('occurrence.has_image')}
        %dd.py-1 #{I18n.t(@occurrence.hasImage.present?.to_s)}

  .card.mb-4
    .card-header.border-bottom
      %h5= I18n.t('occurrence.location')
    .card-body.mt-2
      %dl.dl-horizontal
        %dt country
        %dd.py-1 #{h(@occurrence.country)}
        %dd.line-break

        %dt countryCode
        %dd.py-1 #{h(@occurrence.countryCode)}
        %dd.line-break

        %dt decimalLatitude
        %dd.py-1 #{h(@occurrence.decimalLatitude)}
        %dd.line-break

        %dt decimalLongitude
        %dd.py-1 #{h(@occurrence.decimalLongitude)}
        %dd.line-break

      - if @occurrence.decimalLongitude && @occurrence.decimalLatitude
        #map-wrapper{style:"height: 100%"}
          #map{style: "width:65%;"}

  .card.mb-4
    .card-header.border-bottom
      %h5= I18n.t('occurrence.event')
    .card-body.mt-2
      %dl.dl-horizontal
        %dt eventDate
        %dd.py-1 #{h(@occurrence.eventDate)}
        %dd.line-break

        %dt year
        %dd.py-1 #{h(@occurrence.year)}
        %dd.line-break

        %dt recordedBy
        %dd.py-1 #{h(@occurrence.recordedBy)}
        %dd.line-break

        %dt recordedByID
        %dd.py-1 #{h(@occurrence.recordedByID)}
        %dd.line-break

        - if is_admin?
          %dt Agent Strings
          %dd.py-1.pr-0
            %hr
            .mt-2
              %ul.list-unstyled
                - @occurrence.recorders.each do |agent_recorder|
                  %li.agent_recorders{"data-family": agent_recorder.family}
                    %span
                      #{agent_recorder.fullname}
                    %i.fas.fa-spinner.fa-pulse
          %dd.line-break

        %dt Attributions
        %dd.py-1
          - if @occurrence.user_recordings.count > 0
            %hr
            .mt-2
              - @occurrence.user_recordings.each do |recorder|
                %p.orcid.text-lg-left.p-0.mt-1{"data-user-occurrence-id": "#{recorder.id}", "data-recorders": "#{recorder.user.identifier}"}
                  - if recorder.user.orcid
                    #{recorder.user.fullname_reverse}
                    %a{href: "https://orcid.org/#{recorder.user.orcid}"}
                      %i.fab.fa-orcid
                      https://orcid.org/#{recorder.user.orcid}
                  - else
                    #{recorder.user.fullname_reverse}
                    %img{src: "/images/wikidata_24x24.png", alt:"Wikidata iD"}
                    = link_to "https://www.wikidata.org/wiki/#{recorder.user.wikidata}", "https://www.wikidata.org/wiki/#{recorder.user.wikidata}"
                  - if recorder.claimant != recorder.user
                    %span.d-block.ml-3.text-muted.small
                      Attributed by: #{recorder.claimant.fullname_reverse}
                      %a{href: "https://orcid.org/#{recorder.claimant.orcid}"}
                        %i.fab.fa-orcid
                        https://orcid.org/#{recorder.claimant.orcid}
        %dd.line-break

  .card.mb-4
    .card-header.border-bottom
      %h5= I18n.t('occurrence.identification')
    .card-body.mt-2
      %dl.dl-horizontal
        %dt family
        %dd.py-1 #{h(@occurrence.family)}
        %dd.line-break

        %dt scientificName
        %dd.py-1 #{h(@occurrence.scientificName)}
        %dd.line-break

        %dt typeStatus
        %dd.py-1 #{h(@occurrence.typeStatus)}
        %dd.line-break

        %dt dateIdentified
        %dd.py-1 #{h(@occurrence.dateIdentified)}
        %dd.line-break

        %dt identifiedBy
        %dd.py-1 #{h(@occurrence.identifiedBy)}
        %dd.line-break

        %dt identifiedByID
        %dd.py-1 #{h(@occurrence.identifiedByID)}
        %dd.line-break

        - if is_admin?
          %dt Agent Strings
          %dd.py-1.pr-0
            %hr
            .mt-2
              %ul.list-unstyled
                - @occurrence.determiners.each do |agent_determiner|
                  %li.agent_determiners{"data-family": agent_determiner.family}
                    %span
                      #{agent_determiner.fullname}
                    %i.fas.fa-spinner.fa-pulse
          %dd.line-break

        %dt Attributions
        %dd.py-1
          - if @occurrence.user_identifications.count > 0
            %hr
            .mt-2
              - @occurrence.user_identifications.each do |determiner|
                %p.orcid.text-lg-left.p-0.mt-1{"data-user-occurrence-id": "#{determiner.id}", "data-determiners": "#{determiner.user.identifier}"}
                  - if determiner.user.orcid
                    #{determiner.user.fullname_reverse}
                    %a{href: "https://orcid.org/#{determiner.user.orcid}"}
                      %i.fab.fa-orcid
                      https://orcid.org/#{determiner.user.orcid}
                  - else
                    #{determiner.user.fullname_reverse}
                    %img{src: "/images/wikidata_24x24.png", alt:"Wikidata iD"}
                    = link_to "https://www.wikidata.org/wiki/#{determiner.user.wikidata}", "https://www.wikidata.org/wiki/#{determiner.user.wikidata}"
                  - if determiner.claimant != determiner.user
                    %span.d-block.ml-3.text-muted.small
                      Attributed by: #{determiner.claimant.fullname_reverse}
                      %a{href: "https://orcid.org/#{determiner.claimant.orcid}"}
                        %i.fab.fa-orcid
                        https://orcid.org/#{determiner.claimant.orcid}
        %dd.line-break

%script{id: "selector-template", type: "text/x-handlebars-template"}
  = haml :'partials/single_selector_template', layout: false, locals: { occurrence: @occurrence }
